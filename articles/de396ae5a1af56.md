---
title: "React Compilerã‚’æ·±æ˜ã‚Šã—ã‚ˆã†"
emoji: "ğŸ˜¸"
type: "tech"
topics: ["react", "javascipt"]
published: false
---

# ã¯ã˜ã‚ã«

React ã§ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§å®šç¾©ã—ã¦ã„ã‚‹é–¢æ•°ãƒ»å¤‰æ•°ã‚‚æ–°ã—ãç”Ÿæˆã•ã‚Œã¦ã—ã¾ã„ã€å€¤ãŒå¤‰ã‚ã£ã¦ã„ãªã‹ã£ãŸã¨ã—ã¦ã‚‚å†è¨ˆç®—ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚å†ç²¾ç®—ã‚’é˜²ããŸã‚ã«ã€è©²å½“ã™ã‚‹é–¢æ•°ã‚„å¼•æ•°ã‚’`useMemo` `useCallback` `React.memo`ãªã©ã‚’ã„ã¡ã„ã¡å›²ã‚“ã§ã€å®Ÿè£…è€…ãŒãƒ¡ãƒ¢åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

## ä»Šã¾ã§

### é–¢æ•°ã®å†ç²¾ç®—ã‚’é˜²ããŸã‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
const UseMemoExample = () => {
  const [count, setCount] = useState(0);

  const doubledCount = useMemo(() => {
    return count * 2;
  }, [count]); // countã®å€¤ãŒå¤‰ã‚ã£ã¦ã„ãªã„é™ã‚Šã€å†ç²¾ç®—ã—ãªã„

  return (
    <div>
      <h1>useMemo Example</h1>
      <button onClick={() => setCount(count + 1)}>Increment Count</button>
      <p>Count: {count}</p>
      <p>Doubled Count: {doubledCount}</p>
    </div>
  );
};
```

å†å‡¦ç†ã•ã›ãªã„ãŸã‚ã«å¼•æ•°ã‚’`useMemo`ã«å›²ã¿ã¾ã™

---

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é˜²ããƒ‘ã‚¿ãƒ¼ãƒ³

```ts
export default function App() {
  const [count, setCount] = useState(0);
  return (
    <div className='card'>
      <button onClick={() => setCount(count => count + 1)}>Click me</button>
      <p>count is {count}</p>
      <HeavyComponent />
    </div>
  );
}

function HeavyComponent() {
  return (
    <div>
      <h1>Heavy Component</h1>
    </div>
  );
}
```

`Heavy Component`ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é˜²ããŸã‚ã«ã€`React.Memo`ã«å›²ã¿ã¾ã™

```ts
export default function App() {
  const [count, setCount] = useState(0);
  return (
    <div className='card'>
      <button onClick={() => setCount(count => count + 1)}>Click me</button>
      <p>count is {count}</p>
      <MemoizedHeavyComponent />
    </div>
  );
}

const MemoizedHeavyComponent = React.memo(HeavyComponent); //ãƒ¡ãƒ¢åŒ–ã™ã‚‹

function HeavyComponent() {
  return (
    <div>
      <h1>Heavy Component</h1>
    </div>
  );
}
```

ä»Šã¾ã§ã¯`ã¨ã‚Šã‚ãˆãšãƒ¡ãƒ¢åŒ–`ã—ã¦ã„ãŸã¨ã„ã†å®Ÿæ„Ÿã¯ã‚ã‚Šã¾ã™ã§ã—ã‚‡ã†ã‹ï¼Ÿ
è»½ã„å‡¦ç†ã«å¯¾ã—ã¦ãƒ¡ãƒ¢åŒ–ã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‚ç…§ã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç™ºç”Ÿã—ã¾ã™ã€‚

React Compiler ã¯ã€æ›¸ã„ãŸ**React ã®ã‚³ãƒ¼ãƒ‰**ã‚’å˜ã«ãƒ¡ãƒ¢åŒ–ã‚’ã—ã¦ãã‚Œã‚‹ã®ã¿ã§ã¯ãªãã€ã‚ã‚‰ã‚†ã‚‹ãªä»•çµ„ã¿ã§æœ€é©åŒ–ã—ã¦ãã‚Œã¾ã™

React Compiler ã®æ©Ÿèƒ½ã‚’ç†è§£ã™ã‚‹ã«ã¯ã€ã¾ãšã¯ JSX ã®ã‚³ãƒ¼ãƒ‰ã‚’ã©ã†ã„ã£ãŸå½¢ã§ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã•ã‚Œã‚‹ã®ã‹ã‚’ç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ãª React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

```js
export default function App() {
  const message = "Hello world";
  return <div className='card'>{message}</div>;
}
```

React Compiler ä»¥å‰ã€ä¸Šè¨˜ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™

```js
export default function App() {
  const message = "Hello world";
  return _jsx("div", {
    className: "card",
    children: message,
  });
}
```

ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«ã¯ã€ã“ã®é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã³ã«(å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°)ã€`_jsx`ãŒå®Ÿè¡Œã•ã‚Œã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆå‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
å†å‡¦ç†ã™ã‚‹ãŸã³ã«ã€åŒã˜é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

React Compiler ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚Šã¾ã™

```js
function App() {
  const $ = _c(1);

  let t0;

  if ($[0] === Symbol.for("react.memo_cache_sentinel")) {
    t0 = <div className='card'>{"Hello world"}</div>;
    $[0] = t0;
  } else {
    t0 = $[0];
  }

  return t0;
}
```

### é‡è¦ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹æŒ™å‹•

```js
const $ = _c(1);
```

- `_c()`ã®é–¢æ•°ã¯ã€React19 ã®æ–°ã—ã„ãƒ•ãƒƒã‚¯ `useMemoCache` ã«è©²å½“ã—ã¾ã™ ([å‚ç…§](https://github.com/facebook/react/blob/ea6e05912aa43a0bbfbee381752caa1817a41a86/packages/react-server/src/ReactFlightHooks.js#L84-L92))
  - `1`ã¨ã„ã†å¼•æ•°ã¯ã€ãƒ¡ãƒ¢åŒ–å¯¾è±¡ã®è¦ç´ ã®æ•°ã§ã™ã€‚
  - è¦ç´ ã®æ•°ã®é•·ã•(1)ãŒã‚ã‚‹`REACT_MEMO_CACHE_SENTINEL`ã®é…åˆ—ã‚’è¿”ã—ã¾ã™ã€‚

```js
if ($[0] === Symbol.for("react.memo_cache_sentinel")) {
  t0 = <div className='card'>{"Hello world"}</div>;
  $[0] = t0;
} else {
  t0 = $[0];
}
```

- è©²å½“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆæœŸå€¤ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™ã€‚ğŸ‘‰ `$[0] = t0`

  - ï¼’å›ç›®ä»¥é™ã€ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿”ã—ã¾ã™ã€‚

  :::message
  `React.memo`ãŒè¡Œã†ãƒ¡ãƒ¢åŒ–ã¨ä¼¼ãŸå‡¦ç†ã«ãªã‚Šã¾ã™ã€‚
  :::

- `children`ã® prop ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`message`ã¯**å®šæ•°ãªã®ã§**ã€`const`ã®å®šç¾©ãªããªã‚Šã€ãã®ã¾ã¾æ–‡å­—åˆ—ã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ React Compiler ãã®ä¸€ã¤ã®æ©Ÿèƒ½ã«ãªã‚Šã¾ã™ã€‚ğŸ‘‰ `t0 = <div className='card'>{"Hello world"}</div>`

## å‹•çš„å€¤ãŒã‚ã‚‹æ™‚

`onClick`ç™ºç«ã«ã‚ˆã‚‹ã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

```js
import { useState } from "react";

export default function Counter() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>Increment</button>
    </div>
  );
}
```

React Compiler å‡ºåŠ›

```js
function Counter() {
  const $ = _c(2);

  const [count, setCount] = useState(0);
  let t0;

  if ($[0] !== count) {
    t0 = (
      <div>
        <p>Count: {count}</p>
        <button onClick={() => setCount(count + 1)}>Increment</button>
      </div>
    );
    $[0] = count;
    $[1] = t0;
  } else {
    t0 = $[1];
  }

  return t0;
}
```

- åˆå›ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨å‹•çš„å€¤ã¨ãªã‚‹`count`ã‚’åˆ¥è¦ç´ ã¨ã—ã¦æ‰±ã„ã€ãã‚Œãã‚Œãƒ¡ãƒ¢åŒ–ã—ã¦ã„ã¾ã™ã€‚

  - ï¼’å›ç›®ä»¥é™ã€`count`ãŒå¤‰ã‚ã£ã¦ã„ãªã‘ã‚Œã°ã€ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸ jsx ã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ğŸ‘‰ `if ($[0] !== count)`

- `count`ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ã€`count`ã¨ã¨ã‚‚ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚å†å‡¦ç†ã•ã‚Œã¾ã™ã€‚
