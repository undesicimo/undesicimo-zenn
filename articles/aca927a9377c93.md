---
title: "AIのLost in the Middle現象"
emoji: "🤪"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ai", "llm", "claude", "cursor", "mcp"]
published: true
publication_name: "moneyforward"
published_at: 2025-12-18 09:03
---

コーディングエージェントの登場によって、AI にコンテキストを丸ごと渡して開発することが非常にラクになりました。
プロンプトを書く際、行数の多いファイルを参照したり、プロジェクト全体を読み込ませたりすることも、あまり気にせずにやっていました。

しかし、コンテキスト制限内であっても、情報を詰め込みすぎると AI の性能は劣化します。これを「Lost in the Middle 現象」と呼びます。

## コンテキストウィンドウとは？

コンテキストウィンドウとは、大規模言語モデル（LLM）が一度に見ることができる「入力トークン」と「出力トークン（AI からの返答）」の総量のことです。

- 制限（リミット）：各モデルにはプロバイダーによって設定された固定の制限があります。会話が長くなったり、大量のドキュメントを読み込ませたりしてこの制限を超えると、エラーが発生したり、生成が途中で止まったりします。

- モデルによる違い： 制限はモデルによって大きく異なります。数千トークン級のものもあれば、20 万トークン級のものもあり、さらに一部では 1000 万トークン級の提供もあります。

## Lost in the Middle 現象

情報量が増えるほど、モデルのパフォーマンスは低下していきます。研究によって確認された明確な特性です。

https://arxiv.org/abs/2307.03172

コンテキストが巨大で「肥大化」している場合、モデルはその中にある特定の情報を見つけ出し、精査し、それを活用することが非常に困難になります。つまり、データを入力できたとしても、それを正しく取り出せるとは限らないということです。

- 初頭効果（Primacy bias）： 入力コンテキストの冒頭にある情報は、非常に高い精度で認識・利用されます。
- 親近性効果（Recency bias）： 入力コンテキストの末尾（直近のメッセージなど）にある情報も、同様に重要視されます。
- 真ん中（Middle）： しかし、コンテキストが長くなればなるほど、その中間に配置された情報に対する正答率は低下します。

人間でも、長い会議の「最初の挨拶」と「最後の結論」は覚えていても、途中の議論に中だるみしてしまうことがありますが、AI にもこれと似た「中だるみ」が発生しているのです。

## コンテキストを管理するためのベストプラクティス

### 1. こまめにチャット履歴をクリアする

最も単純かつ効果的な方法は、タスクが一区切りついた段階で会話履歴をクリアすることです。
Claude Code などのツールでは `clear` コマンドが用意されています。これによりコンテキストがリフレッシュされ、AI は不要な「中間情報のノイズ」に惑わされなくなります。「AI の回答の精度が落ちてきたな」と感じたら、新しいセッションを始めるのが最善策です。

### 2. 会話を「要約（Compact）」する

履歴をすべて消したくない場合、会話を要約して圧縮する方法があります。
Claude Code には `compact` コマンドがあり、これまでの長いやり取りを短い要約メッセージに変換してくれます。これにより、文脈や重要な意図を残しつつ、トークン消費量を劇的に（例：70k トークン → 4k トークン）削減し、Lost in the Middle を回避できます。
ただし、要約の生成自体にトークンと時間を消費する点には注意が必要です。

https://code.claude.com/docs/ja/costs

### 3. MCP サーバーやルールの肥大化に注意する

MCP サーバーや、`.cursorrules` や `CLAUDE.md` などのルールファイルは便利ですが、これらは会話を始める前からコンテキストを圧迫します。ツール定義やルールだけで数万トークンを使ってしまうと、肝心のコードを読み込ませた瞬間に「中間」が発生しやすくなります。常にリーンなコンテキストを保つため、MCP サーバーの追加は慎重に行い、ルールファイルも必要最小限に留めて、定期的に見直しましょう。

Claude Code では、`/context` コマンドがおすすめです。現在使用しているコンテキストの詳細な内訳を可視化できます。
有効になっているのに、まったく使っていない MCP サーバーが、知らないうちにコンテキストを圧迫してしまうことがあります。

https://medium.com/@porter.nicholas/reclaiming-context-with-claude-code-cli-1a92959cd5fb

### 4. 「重要情報」を前後に寄せ、参照しやすい形にする

Lost in the Middle の性質上、「絶対に守ってほしい制約」「最重要の前提」「手順」は、冒頭（または末尾）に置くほど効果的です。
また、長文のまま渡すよりも、AI が引用・再利用しやすい形（箇条書きのチェックリスト、短い仕様、関数シグネチャの抜粋）にして渡すと、見落としが減ります。

## 終わりに

コンテキストウィンドウは「大きければ大きいほど良い」わけではありません。Lost in the Middle 現象を意識し、こまめなクリアや要約を活用して、AI の性能を最大限に引き出しましょう。
