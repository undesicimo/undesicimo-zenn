---
title: "Firebase Emulatorã‚’Dockerã§ç«‹ã¡ä¸Šã’ã‚‹"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [firebase, docker]
published: true
---

`firebase.json`ã‚’å®šç¾©

```json:firebase.json
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "storage": {
    "rules": "storage.rules"
  },
  "emulators": {
    "singleProjectMode": true,
    "firestore": {
      "port": 8080,
      "host": "0.0.0.0"
    },
    "ui": {
      "enabled": true,
      "host": "0.0.0.0"
    },
    "storage": {
      "port": 9199,
      "host": "0.0.0.0"
    },
    "auth": {
      "port": 9099,
      "host": "0.0.0.0"
    }
  }
}
```

ç¾çŠ¶ãƒ›ã‚¹ãƒˆåã‚’`"0.0.0.0"`ã«è¨­å®šã—ãªã„ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶šã§ããªã„ã€‚

https://firebase.google.com/docs/emulator-suite/install_and_configure

æœ¬ç•ªã¨é–‹ç™ºç’°å¢ƒã®ã‚¢ãƒ—ãƒªã‚¤ãƒ‹ã‚·ãƒ£ãƒ©ã‚¤ã‚¶ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‹

```ts: firebaseAppSingleton
import { FirebaseApp, initializeApp } from "firebase/app";
import { Auth, connectAuthEmulator, getAuth } from "firebase/auth";
import {
  connectFirestoreEmulator,
  Firestore,
  getFirestore,
} from "firebase/firestore";
import {
  connectStorageEmulator,
  FirebaseStorage,
  getStorage,
} from "firebase/storage";


export class FirebaseSingleton {
  private static instance: FirebaseSingleton;
  private app: FirebaseApp;
  private storage: FirebaseStorage;
  private db: Firestore;
  private auth: Auth;
  private constructor(config: FirebaseConfig = firebaseConfig) {
    this.app = initializeApp(config);

    if (process.env.NODE_ENV === "development") { //ğŸ’¡ é–‹ç™ºç’°å¢ƒã®å ´åˆ
      console.info("Using Firebase Emulator");
      const db = getFirestore();
      const storage = getStorage();
      const auth = getAuth();

      // ğŸ’¡ Firestore, CloudStorage, Firebase Authãã‚Œãã‚Œ initialize
      connectFirestoreEmulator(db, "127.0.0.1", 8080);
      connectStorageEmulator(storage, "127.0.0.1", 9199);
      connectAuthEmulator(auth, "http://127.0.0.1:9099", {
        disableWarnings: true, //ğŸ’¡ Warningã‚’æ¶ˆã™
      });

      this.db = db;
      this.storage = storage;
      this.auth = auth;
    } else {
      //ğŸ’¡ ä»¥ä¸‹ã¯æœ¬ç•ªç³»
      this.storage = getStorage(this.app);
      this.db = getFirestore(this.app);
      this.auth = getAuth(this.app);
    }
  }
  ....

```

https://firebase.google.com/docs/emulator-suite/connect_auth

ä»¥ä¸‹ã®é€šã‚Šã«`Dockerfile`ã‚’ä½œæˆ

```docker: Dockerfile
FROM node:20-bullseye-slim

RUN apt update -y && apt install -y openjdk-11-jdk bash

RUN npm install -g firebase-tools

RUN apt-get update && apt-get install -y procps

COPY . .

ENTRYPOINT ["firebase", "emulators:start"]
```

å¿…è¦ã¨ãªã‚‹ jdk ã¨ firebase-tools ã§ã‚³ãƒ³ãƒ†ãƒŠã®ç’°å¢ƒæ§‹ç¯‰ã—ã¾ã™

ç«‹ã¡ã‚ã’ã‚„ã™ãã™ã‚‹ãŸã‚ã«`docker compose`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™

```yml:docker.compose.yml
version: "1"

services:
  firebase-emulators:
    volumes:
      - database:/database/firebase
    container_name: firebase-emulators
    build:
      context: ../../
      dockerfile: docker/firebase-docker/Dockerfile
    ports:
      - 8080:8080 # FIRESTORE_PORT
      - 4000:4000 # UI_PORT
      - 9199:9199 # STORAGE_PORT
      - 9099:9099 # AUTH_PORT

volumes:
  database:
```

ç«‹ã¡ä¸Šã’ç”¨ã® npm ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„

```json:package.json
    "emulators:up": "cd docker/firebase-docker && docker-compose up -d",
    "emulators:down": "cd docker/firebase-docker && docker-compose down",
```

ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã® UI ã¯`localhost:4000`ã§ç¢ºèªã§ãã¾ã™ã€‚
